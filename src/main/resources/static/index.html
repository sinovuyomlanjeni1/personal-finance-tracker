<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finance Tracker</title>
</head>
<body>
<h1>Personal Finance Tracker</h1>

<div>
    <input id="type" placeholder="income/expense">
    <input id="category" placeholder="category">
    <input id="amount" placeholder="amount" type="number">
    <button id="saveBtn" onclick="saveTransaction()">Add</button>
</div>

<h2>Transactions</h2>
<ul id="transactionList"></ul>

<h2>Balance: <span id="balance"></span></h2>

<script>
    let editingId = null; // null if adding, set to transaction id if editing

    async function loadTransactions() {
      try {
        let res = await fetch("/api/transactions/all");
        let data = await res.json();

        document.getElementById("transactionList").innerHTML =
          data.map(t => `
            <li>
              ${t.type} - ${t.category} - ${t.amount} (${t.date || "no date"})
              <button onclick="editTransaction(${t.id})">Edit</button>
              <button onclick="deleteTransaction(${t.id})">Delete</button>
            </li>
          `).join("");
      } catch (err) {
        console.error(err);
        alert("Error loading transactions. See console for details.");
      }
    }

    async function saveTransaction() {
      const transaction = {
        type: document.getElementById("type").value,
        category: document.getElementById("category").value,
        amount: parseFloat(document.getElementById("amount").value),
        date: new Date().toISOString().split("T")[0]
      };

      try {
        let url = "/api/transactions/add";
        let method = "POST";

        if (editingId !== null) {
          url = "/api/transactions/" + editingId;
          method = "PUT";
        }

        let res = await fetch(url, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(transaction)
        });

        if (!res.ok) throw new Error("Failed to save transaction: " + res.status);

        // Reset form
        editingId = null;
        document.getElementById("saveBtn").innerText = "Add";
        document.getElementById("type").value = "";
        document.getElementById("category").value = "";
        document.getElementById("amount").value = "";

        loadTransactions();
        loadBalance();
      } catch (err) {
        console.error(err);
        alert("Error saving transaction. See console for details.");
      }
    }

    async function editTransaction(id) {
      try {
        let res = await fetch("/api/transactions/all");
        let data = await res.json();
        const t = data.find(tx => tx.id === id);
        if (!t) return alert("Transaction not found");

        document.getElementById("type").value = t.type;
        document.getElementById("category").value = t.category;
        document.getElementById("amount").value = t.amount;

        editingId = id;
        document.getElementById("saveBtn").innerText = "Save";
      } catch (err) {
        console.error(err);
        alert("Error editing transaction. See console for details.");
      }
    }

    async function deleteTransaction(id) {
      if (!confirm("Are you sure you want to delete this transaction?")) return;

      try {
        let res = await fetch("/api/transactions/" + id, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete transaction: " + res.status);
        loadTransactions();
        loadBalance();
      } catch (err) {
        console.error(err);
        alert("Error deleting transaction. See console for details.");
      }
    }

    async function loadBalance() {
      try {
        let res = await fetch("/api/transactions/balance");
        let balance = await res.text();
        document.getElementById("balance").innerText = balance;
      } catch (err) {
        console.error(err);
        alert("Error loading balance. See console for details.");
      }
    }

    // Initial load
    loadTransactions();
    loadBalance();
</script>
</body>
</html>